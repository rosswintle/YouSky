<footer class="w-full px-8 py-4 bg-slate-200"></footer>

<script
    defer
    src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
></script>
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>-->

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.store("appData", {
            selectHashtag(tag) {
                const data = Alpine.$data(document.querySelector("[x-data]"));
                if (data && data.selectedHashtag !== tag) {
                    data.selectedHashtag = tag;
                    data.view = "hashtag";
                    data.loadPosts();
                }
            },
        });
    });

    function app() {
        return {
            posts: [],
            displayPosts: [],
            newPost: { content: "", post_date: "" },
            editingPost: null,
            replyingTo: null,
            searchQuery: "",
            view: "timeline",
            selectedHashtag: "",
            threadId: null,

            init() {
                this.loadFromStorage();
                this.setDefaultDate();
                this.loadPosts();
            },

            setDefaultDate() {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const localTime = new Date(now - offset);
                this.newPost.post_date = localTime.toISOString().slice(0, 16);
            },

            loadFromStorage() {
                const stored = localStorage.getItem("yousky_posts");
                this.posts = stored ? JSON.parse(stored) : [];
            },

            saveToStorage() {
                localStorage.setItem(
                    "yousky_posts",
                    JSON.stringify(this.posts),
                );
            },

            loadPosts() {
                let filtered = [...this.posts];

                if (this.threadId) {
                    const mainPost = this.posts.find(
                        (p) => p.id === this.threadId,
                    );
                    const replies = this.posts.filter(
                        (p) => p.parent_id === this.threadId,
                    );
                    filtered = mainPost
                        ? [
                              mainPost,
                              ...replies.sort(
                                  (a, b) =>
                                      new Date(a.post_date) -
                                      new Date(b.post_date),
                              ),
                          ]
                        : [];
                } else if (this.view === "search" && this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(
                        (p) =>
                            p.content.toLowerCase().includes(query) ||
                            (p.hashtags &&
                                p.hashtags.some((h) =>
                                    h.toLowerCase().includes(query),
                                )) ||
                            (p.mentions &&
                                p.mentions.some((m) =>
                                    m.toLowerCase().includes(query),
                                )),
                    );
                } else if (this.view === "hashtag") {
                    const lowerCaseTag = this.selectedHashtag.toLowerCase();
                    filtered = filtered.filter(
                        (post) =>
                            post.hashtags &&
                            post.hashtags
                                .map((tag) => tag.toLowerCase())
                                .includes(lowerCaseTag),
                    );
                }

                if (this.view === "timeline" || this.view === "search") {
                    filtered = filtered.sort(
                        (a, b) => new Date(b.post_date) - new Date(a.post_date),
                    );
                }

                this.displayPosts = filtered;
            },

            submitPost() {
                if (
                    !this.newPost.content.trim() ||
                    this.newPost.content.length > 500
                )
                    return;

                const post = {
                    id:
                        Date.now().toString() +
                        Math.random().toString(36).substr(2, 9),
                    content: this.newPost.content.trim(),
                    post_date: new Date(this.newPost.post_date).toISOString(),
                    parent_id: this.replyingTo ? this.replyingTo.id : null,
                    hashtags: this.extractHashtags(this.newPost.content),
                    mentions: this.extractMentions(this.newPost.content),
                    created_date: new Date().toISOString(),
                };

                this.posts.push(post);
                this.saveToStorage();
                this.loadPosts();

                this.newPost.content = "";
                this.setDefaultDate();
                this.replyingTo = null;
            },

            editPost(post) {
                this.editingPost = {
                    ...post,
                    post_date: new Date(post.post_date)
                        .toISOString()
                        .slice(0, 16),
                };
            },

            saveEdit() {
                if (!this.editingPost) return;

                const index = this.posts.findIndex(
                    (p) => p.id === this.editingPost.id,
                );
                if (index !== -1) {
                    this.posts[index] = {
                        ...this.editingPost,
                        post_date: new Date(
                            this.editingPost.post_date,
                        ).toISOString(),
                        hashtags: this.extractHashtags(
                            this.editingPost.content,
                        ),
                        mentions: this.extractMentions(
                            this.editingPost.content,
                        ),
                    };
                    this.saveToStorage();
                    this.loadPosts();
                }
                this.editingPost = null;
            },

            deletePost(id) {
                if (!confirm("Delete this post and all its replies?")) return;

                const toDelete = new Set([id]);
                const findReplies = (parentId) => {
                    this.posts.forEach((p) => {
                        if (p.parent_id === parentId) {
                            toDelete.add(p.id);
                            findReplies(p.id);
                        }
                    });
                };
                findReplies(id);

                this.posts = this.posts.filter((p) => !toDelete.has(p.id));
                this.saveToStorage();
                this.loadPosts();

                if (this.threadId === id) {
                    this.threadId = null;
                    this.view = "timeline";
                    this.loadPosts();
                }
            },

            replyTo(post) {
                this.replyingTo = post;
                if (this.threadId) {
                    this.threadId = null;
                    this.view = "timeline";
                    this.loadPosts();
                }
                window.scrollTo({ top: 0, behavior: "smooth" });
            },

            openThread(postId) {
                this.threadId = postId;
                this.view = "thread";
                this.loadPosts();
                window.scrollTo({ top: 0, behavior: "smooth" });
            },

            search() {
                this.loadPosts();
            },

            extractHashtags(text) {
                const matches = text.match(/#[a-zA-Z0-9_]+/g) || [];
                return [...new Set(matches.map((tag) => tag.toLowerCase()))];
            },

            extractMentions(text) {
                const matches = text.match(/@[a-zA-Z0-9_]+/g) || [];
                return [...new Set(matches.map((m) => m.toLowerCase()))];
            },

            getReplyCount(postId) {
                return this.posts.filter((p) => p.parent_id === postId).length;
            },

            getParentContent(parentId) {
                const parent = this.posts.find((p) => p.id === parentId);
                return parent
                    ? parent.content.slice(0, 50) +
                          (parent.content.length > 50 ? "..." : "")
                    : "";
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diff = now - date;
                const days = diff / (1000 * 60 * 60 * 24);

                if (days > 7) {
                    return date.toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                        year: "numeric",
                    });
                } else {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor(diff / (1000 * 60));
                    if (minutes < 60) return minutes + "m";
                    if (hours < 24) return hours + "h";
                    return Math.floor(days) + "d";
                }
            },

            renderMarkdown(content) {
                if (!window.marked) return content;
                let html = marked.parse(content);

                // Add hashtag and mention styling
                html = html.replace(
                    /(?<!&)#([a-zA-Z0-9]\w*)/g,
                    (match, tag) => {
                        return (
                            "<button onclick=\"Alpine.store('appData').selectHashtag('#" +
                            tag +
                            '\')" class="text-sky-500 hover:text-sky-600 hover:underline cursor-pointer">#' +
                            tag +
                            "</button>"
                        );
                    },
                );

                html = html.replace(
                    /@([a-zA-Z0-9_]+)/g,
                    '<span class="text-violet-500 font-medium">@$1</span>',
                );

                return html;
            },

            selectHashtag(tag) {
                this.selectedHashtag = tag;
                this.view = "hashtag";
                this.loadPosts();
            },

            removeHashtag(tag) {
                this.selectedHashtag = "";
                this.view = "timeline";
                this.loadPosts();
            },

            exportData() {
                const data = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    posts: this.posts,
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: "application/json",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `yousky-export-${new Date().toISOString().split("T")[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.posts = data.posts || data;
                        this.saveToStorage();
                        this.loadPosts();
                        alert("Data imported successfully!");
                    } catch (err) {
                        alert("Error importing data: " + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = "";
            },
        };
    }
</script>

<!-- Live watch script -->
<?php if (ENVIRONMENT === 'DEVELOPMENT') : ?>
<script id="live.js" src="/dev-js/live.js"></script>
<?php endif; ?>
